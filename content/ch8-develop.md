# 项目开发

本节我们介绍具体的开发流程。如上一节所言，常见的算法项目大多数看起来都是以项目为粒度的，具体原因前面也解释过。但是如果我们从整体架构上考虑，会发现这样并不合适。关于架构这块，我们上节已经强调过了，这里再补充一点。即使是算法服务，也应该有完整的后端服务，如果没有配后端，那算法工程师理应担起这个责任。算法工程师首先是工程师。因此，正常情况下，我们对外或对内提供的服务最好是有统一的gateway出口，分scope、多粒度、按接口统一认证鉴权，统一测试部署，统一日志服务。不要将算法部门割裂成一块一块。本节主要关注代码层面，包括以下内容：

- 好的工程需要精心设计
- 写代码容易写好代码难
- 不断追求更精湛的技艺

## 好的工程需要精心设计

如果你是一个工作多年的工程师，一定会遇到转交到你手里的历史遗留项目。我相信大多数人一定会遇到「屎山」，而且很可能不止一次，每次都「屎」的不一样。不过最「屎」的就是没有任何设计的代码了，简直是灾难。我们一般在讲到代码设计时主要指这几个方面：

- API设计：包括HTTP RESTFUL API、GRPC API和模块API
- 代码结构的设计和组织
- 类/函数/参数设计

**API设计**

我们一一来展开介绍。首先看API设计。API由于是给其他人（当然也包括自己）使用的，所以第一要注意的是，不要频繁变化。如有必要，可以增加版本，比如`api/v1/sentiment_analysis`中`v1`可以升级到`v2`，但最好不要改接口名字。

其次要注意的是接口要尽量向后兼容，当接口发生改变时，要保证即时对方不更新也能在旧版本上正常提供服务。这就要求在提供参数时要精心设计，哪些参数是必填的，哪些是可选的，是否提供默认值等都应该仔细斟酌。

一个接口理论上应该只做一件事，注意这个一件事不一定是一个功能。比如很多RPC Client接口（上节的Triton）就是一套，但可以通过参数切换使用不同模型，它也是只做了一件事。

接口风格应尽量统一，比如同样的预测推理接口，不要有的是`run`，有的是`predict`，有的又是`infer`。最好统一继承基类，然后在具体的子类上覆盖。

接口命名应能概括接口的主要功能，符合人的常识或认知，不要标新立异。给别人用的，简单、直观最重要。

接口参数不要传一大包东西。我们之前有个接口，做的是对话分析，结果后端把整通对话和所有相关意图库都通过参数传过来，只是参数的body转成json都有差不多2M。这种事情万万不要做，接口要精巧，这种数据自己到库里去取。题外话，算法工程师对数据库应该非常熟悉，而且对外服务时数据库几乎是必备的。所有「业务」相关的逻辑都可能需要对接业务数据库，而且你还要鉴权不是吗。

提供对外接口文档！包括简要描述、scope、接口、请求方法、Header、入出参数、使用示例等。

**结构设计**

接下来谈一下代码结构的设计和组织。其实API设计中有些原则也是适用的，比如只做一件事、风格统一、命名简单等，我们就不赘述了。这里从结构角度谈谈。

首先，应该将结构体和行为分开。在很多语言中都有类似的接口，比如Java的`class`和`interface`。对于数据类可以专门处理，比如Python提供的`dataclass`。

设计好不同变量和方法的可见范围，合理安排权限。在Java中就是`public`、`protected`和`private`，Python一般用一个下划线表示受保护的，两个下划线表示私有的。

写好类型标记。这个在动态语言中因为太随意导致很多人不注意，不过渐渐地像JavaScript、Python对类型标记都支持的比以前更好了。在算法中比较特殊的是有时候输入的是矩阵、张量，这时候不要简单的标记一个Tensor或Array，最好把shape、类型都给标记一下。Python大家可以阅读PEP 646，其他语言也可以自己设计专门的标记类。

合理地使用继承和组合。继承可以省很多代码，但一不小心就能写出坑来。继承多了连自己可能都晕了。建议不要超过两层以上的继承，如果不是行为类的添加，不要多重继承。

了解常用设计模式，并在实践中灵活使用。尤其掌握算法比较常用的几种模式，比如：策略模式、职责链模式、外观模式、状态模式、适配器模式、单例模式等。特别注意不要死搬硬套，很多时候我们可能将多个设计模式融合后使用，也可能只用了某个设计模式的一部分。设计模式大家可以将它理解成常用问题方案的「套路」，如果你正好遇见类似场景，可以将其作为参考解决方案。

代码的组织也要提一下，最重要的是分类和分层。分类好说，MVC是最简单和经典的分法，实际项目可能需要相应调整。总的来说，有这个意识就好。分层很多人不太注意，虽然不知不觉中也分了，但一看就没有设计过。最简单的做法就是从router开始，到view，再到controller，再到具体的function实现一层层下去，每一层做好自己的事情。举个例子，router尽量简单，做网络、校验相关的事情；view应该和具体某项业务有关，一般需要操作到数据库；controller完成某个具体的功能。

**具体设计**

接下来到了具体代码环节。首先要说的就是类、函数和参数的命名，起个好名字其实挺难的，所以平时会见到很多随手起的名字。函数后面带1、2、3的；不管什么先搞个类，好像有个类代码看起来比较好似的；还有类似a、b、c这样的参数名。起名的问题在API那里已经提过了，原则同样适用：统一、直观、简单，函数只做一件事。再补充一点，类和模块一般是名词，函数一般是动词。行为类一般是形容词，数据类一般是名词。

类的设计前面提到一些，这里不再赘述。补充说一下不同的类方法，无论哪种语言，都支持多种类方法，比如默认方法、静态方法等。这几个方法其实都比较直观，一般和实例无关但与类相关的方法，我们构建为类方法；静态方法则比较特殊，一般是和类有关但比较独立（不依赖类或实例状态、变量）的功能。类的命名最好按社区约定，不要随心所欲地写。

函数（或方法）的设计核心就是只做一件事，可以将多个函数组合起来用，但不要搞一个很大的函数。函数命名也应该符合社区规范，另外不要怕名字太长（太长的单词可以选前4个字母或简称）。

参数主要是命名和类型标记，之前已经提到过了。这里额外强调两点：第一，参数的数量不要太多，实在太多的时候你就应该考虑是不是应该拆分功能，或者将参数装到一个类里面。第二，理解并灵活使用各种不同类型参数，包括默认参数、位置参数、可变参数等。对于强类型语言，可以多使用函数重载，减少各种if else。

好了，关于代码设计就先讲这么多。需要说明的是，以上其实不是必须的，不过还是建议大家考虑这些因素，不光别人看起来轻松，自己时间长了再看也会很方便。

## 写代码容易写好代码难

写代码是一项技能，一项需要不断练习的技能。就像一门乐器一样，入门非常简单，但要精通就不那么容易了，需要长时间的积累。这种积累不仅是对于技能的熟悉，而且是更深层次和对本质的理解。那什么是好代码，或者说怎样的代码才能被称作是好的代码？我们可以从多个角度列举很多标准出来，但大的方面关键不外乎以下几个方面：

- 清晰
- 健壮
- 扩展性

**清晰**

这里其实还有一个最最基础的标准：正确性，无需多言。清晰的代码意味着让阅读者一眼看过去就明白在做什么，这涉及到多个方面，比如前面提到的代码设计、合理的注释、一致的风格等。代码设计之前详细介绍过了，从API到整体结构再到具体的类、函数等，各个环节都有不少细节。

注释作为工程师都不陌生，我们肯定也都读过别人的注释。好的注释应该是Why而不是What和How，很多注释就是对下面句子的中文翻译，这样的注释没有太多意义。

再就是风格，每种语言都有各种风格工具，比如Python有pylint、flake8、yepf等。糟糕的排版会给阅读者带去糟糕的心情。

清晰的代码是多年的训练和长期坚持良好的习惯共同作用的结果，当然，还少不了对代码的不断重构。这也是咱们之前说到的，为什么要站在整体架构的角度统一设计服务和模块。这样随着项目不断增多，变得越来越复杂，局部的重构必不可少。每次的重构都是一次代码质量的提升，任何项目的好代码都不是一下写出来的，而是多个版本长时间的迭代、优化、重构而来的。如果我们还是以项目为粒度，case by case的话，你会习惯性地复制之前的项目。更可惜的是，就单个项目来说，它的复杂度大概率是不高的，我们很难锻炼到自己的架构思维和设计能力。

**健壮**

健壮意味着不出问题，没有Bug。绝对的没有Bug不太可能，但Bug越来越少，到后面几乎没有Bug这还是比较常见的。要做到这一点，精心的设计肯定是有帮助的，再就是长期的实践经验。但我们想说最重要的还是测试驱动开发。我本人很幸运，在转行后遇到一个非常厉害的算法工程师，工程能力极强，他教会了我很多，其中就包括测试驱动开发。多年来受益匪浅，上线过多个项目，罕有遇到线上Bug的情况，如果不算badcase的话，只有寥寥一两次。其实好的习惯和坏习惯一样，一旦养成也很难改。现在对我来说，只要是上线的项目，必然会有测试。那我也想把这个习惯分享给大家，希望大家从一开始写项目就能有一个好习惯。而且，其实是它并不会浪费我们太多时间。

测试驱动开发，也叫TDD，关于这个东西其实各种观点都有。有极端点的，先写测试再写代码，也有的先把代码写了再补测试（不过依我经验来看，说后面补测试的，基本都没有补）。有的人追求100%覆盖率，也有的人写一个简单的调用。这些做法对大多数人来说，要么太苛刻，要么没啥用。

其实，我们不妨换个思路，先回答为啥要写测试？最重要的原因就是确保一些功能比较复杂的、或者核心的函数能够在各种情况下正常运行。所以，测试需要100%覆盖吗，不一定。那对于这种复杂、核心的函数，平时大多数人的做法是咋样的呢？我看过很多人都在下面写个main方法，然后自己跑case测。为什么不把这个过程放到测试代码里呢？对于你觉得不放心的代码，当你需要在文件下面写main方法测试的代码，把这个逻辑放到测试代码里。

在我看来这就是很好地TDD了。你的时间并没有多花费多少，但是测试代码在你日后模块更新时依然起作用；在多个模块交互时，测试代码运行起来更加方便直接。何乐而不为。写一次测试，日后一直生效，这种一劳永逸的事情绝对值得稍微花一点点时间的。我碰到过好几次同事因为更新接口影响了原来的接口，我也碰到过，不过在跑测试环节被发现了。

**扩展性**

扩展性其实和之前提到的设计有关系，简单来说，就是在设计代码时，要往前多看几步，但又不能太多步。这在你从整体考虑架构时会更加明显。我们举个很简单的例子，比如大模型的生成，有些人可能一开始为了简单，只接受单样本输入。结果后面想batch的时候却没法用。正确的做法是一开始就batch，然后使用batch_size=1作为开始。

要想让代码具有扩展性，比较常见的做法包括以下几个方面。





## 不断追求更精湛的技艺



